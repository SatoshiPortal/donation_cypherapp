version: "3"

services:
  donation:
    environment:
      - "TRACING=1"
      - "CYPHERNODE_URL=https://gatekeeper:${GATEKEEPER_PORT}"
    image: donation
    entrypoint: ["npm", "run", "start:dev"]
    volumes:
      - "$APP_SCRIPT_PATH/data:/donation/data"
      - "$GATEKEEPER_DATAPATH/certs/cert.pem:/donation/cert.pem:ro"
      - "$LOGS_DATAPATH:/donation/logs"
    networks:
      - cyphernodeappsnet
    restart: always
    labels:
      - "traefik.docker.network=cyphernodeappsnet"
      - "traefik.frontend.rule=Host:api.donate.yourdomain.dev"
#        - "traefik.frontend.rule=PathPrefixStrip:/donation"
      - "traefik.frontend.passHostHeader=true"
      - "traefik.enable=true"
      - "traefik.port=8000"
      - "traefik.domain=api.donate.yourdomain.dev"
      - "traefik.frontend.headers.allowedHosts=api.donate.yourdomain.dev"
      - "traefik.frontend.rateLimit.extractorFunc=request.host"
      - "traefik.frontend.rateLimit.rateSet.rateset1.period=1s"
      - "traefik.frontend.rateLimit.rateSet.rateset1.average=1"
      - "traefik.frontend.rateLimit.rateSet.rateset1.burst=2"
      # yourapiuser:82b5313656818b70d900c32c3bf8ea502705048392f96a4c4f65d0e270d576fe
      - "traefik.frontend.auth.basic.users=yourapiuser:$$2y$$05$$M0vR2UtI.I5JlV9Ha3j/buXwfXuyG6QqnjSBgSkkJomGaynIS1lPO"
    deploy:
      labels:
        - "traefik.docker.network=cyphernodeappsnet"
        - "traefik.frontend.rule=Host:api.donate.yourdomain.dev"
#        - "traefik.frontend.rule=PathPrefixStrip:/donation"
        - "traefik.frontend.passHostHeader=true"
        - "traefik.enable=true"
        - "traefik.port=8000"
        - "traefik.domain=api.donate.yourdomain.dev"
        - "traefik.frontend.headers.allowedHosts=api.donate.yourdomain.dev"
        - "traefik.frontend.rateLimit.extractorFunc=request.host"
        - "traefik.frontend.rateLimit.rateSet.rateset1.period=1s"
        - "traefik.frontend.rateLimit.rateSet.rateset1.average=1"
        - "traefik.frontend.rateLimit.rateSet.rateset1.burst=2"
        # yourapiuser:82b5313656818b70d900c32c3bf8ea502705048392f96a4c4f65d0e270d576fe
        - "traefik.frontend.auth.basic.users=yourapiuser:$$2y$$05$$M0vR2UtI.I5JlV9Ha3j/buXwfXuyG6QqnjSBgSkkJomGaynIS1lPO"
      replicas: 1
      placement:
        constraints:
          - node.labels.io.cyphernode == true
      restart_policy:
        condition: "any"
        delay: 1s
      update_config:
        parallelism: 1    
networks:
  cyphernodeappsnet:
    external: true

# This is how you can generate a random authentication key:
# server:~$ dd if=/dev/urandom bs=32 count=1 2> /dev/null | xxd -ps -c 32
# 82b5313656818b70d900c32c3bf8ea502705048392f96a4c4f65d0e270d576fe
# server:~$ htpasswd -bnB yourapiuser '82b5313656818b70d900c32c3bf8ea502705048392f96a4c4f65d0e270d576fe' | sed 's/\$/\$\$/g'
# yourapiuser:$$2y$$05$$M0vR2UtI.I5JlV9Ha3j/buXwfXuyG6QqnjSBgSkkJomGaynIS1lPO
